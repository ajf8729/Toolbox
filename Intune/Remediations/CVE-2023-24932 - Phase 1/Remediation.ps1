try {
    Confirm-SecureBootUEFI | Out-Null
}
catch {
    Write-Output 'System is either legacy BIOS or UEFI without secure boot enabled'
    exit 1
}

$WindowsUEFICA2023Capable = Get-ItemPropertyValue -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecureBoot\Servicing -Name WindowsUEFICA2023Capable
$AvailableUpdates = Get-ItemPropertyValue -Path HKLM:\SYSTEM\CurrentControlSet\Control\Secureboot -Name AvailableUpdates
$SecureBootDBCheck = [System.Text.Encoding]::ASCII.GetString((Get-SecureBootUEFI db).bytes) -match 'Windows UEFI CA 2023'
#$SecureBootDBXCheck = [System.Text.Encoding]::ASCII.GetString((Get-SecureBootUEFI dbx).bytes) -match 'Microsoft Windows Production PCA 2011'

if ($WindowsUEFICA2023Capable -eq 2 -and $AvailableUpdates -eq 0 -and $SecureBootDBCheck) {
    Write-Output 'Windows UEFI CA 2023 certificate is in the DB and the system is starting from the 2023 signed boot manager'
    exit 0
}

if ($WindowsUEFICA2023Capable -eq 1 -and $AvailableUpdates -eq 0 -and $SecureBootDBCheck) {
    Write-Output 'Windows UEFI CA 2023 certificate is in the DB, but the system is NOT starting from the 2023 signed boot manager'
    exit 1
}

if ($WindowsUEFICA2023Capable -eq 0 -and $AvailableUpdates -eq 0) {
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\Secureboot -Name AvailableUpdates -Value 0x140 -Force
}
