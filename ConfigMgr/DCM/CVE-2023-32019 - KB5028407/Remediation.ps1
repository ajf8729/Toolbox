$Version = (Get-CimInstance -ClassName Win32_OperatingSystem).Version
$UBR = (Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\' -Name 'UBR').UBR

switch ($Version) {
    # Windows 10 21H2/22H2
    {$_ -in '19044', '19045'} {
        if ($UBR -ge 3086) {
            New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4103588492' -PropertyType DWord -Value 1 -Force
        }
    }
    # Windows 11 21H2
    '22000' {
        if ($UBR -ge 2057) {
            New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4204251788' -PropertyType DWord -Value 1 -Force
        }
    }
    # Windows 11 22H2
    '22621' {
        if ($UBR -ge 1848) {
            New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4237806220' -PropertyType DWord -Value 1 -Force
        }
    }
    # Server 2016
    '14393' {
        if ($UBR -ge 5989) {
            New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -PropertyType DWord -Value 0 -Force
        }
    }
    # Server 2019
    '17763' {
        if ($UBR -ge 4499) {
            New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -PropertyType DWord -Value 0 -Force
        }
    }
    # Server 2022
    '20348' {
        if ($UBR -ge 1787) {
            New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4137142924' -PropertyType DWord -Value 1 -Force
        }
    }
}
