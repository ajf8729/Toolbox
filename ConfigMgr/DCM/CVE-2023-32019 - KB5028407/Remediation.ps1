$Version = (Get-CimInstance -ClassName Win32_OperatingSystem).Version
$UBR = (Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\' -Name 'UBR').UBR
$Build = "$Version.$UBR"

switch ($Build) {
    # Windows 10 21H2
    '10.0.19044.3086' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4103588492' -PropertyType DWord -Value 1 -Force
    }
    # Windows 10 22H2
    '10.0.19045.3086' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4103588492' -PropertyType DWord -Value 1 -Force
    }
    # Windows 11 21H2
    '10.0.22000.2057' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4204251788' -PropertyType DWord -Value 1 -Force
    }
    # Windows 11 22H2
    '10.0.22621.1848' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4237806220' -PropertyType DWord -Value 1 -Force
    }
    # Server 2016
    '10.0.14393.5989' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -PropertyType DWord -Value 0 -Force
    }
    # Server 2019
    '10.0.17763.4499' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -PropertyType DWord -Value 0 -Force
    }
    # Server 2022
    '10.0.20348.1787' {
        New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4137142924' -PropertyType DWord -Value 1 -Force
    }
}
