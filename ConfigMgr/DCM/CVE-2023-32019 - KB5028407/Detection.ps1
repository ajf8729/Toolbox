$Compliant = $true

$BuildNumber = (Get-CimInstance -ClassName Win32_OperatingSystem).BuildNumber
$UBR = (Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\' -Name 'UBR').UBR

switch ($BuildNumber) {
    # Windows 10 21H2/22H2
    {$_ -in '19044', '19045'} {
        # https://support.microsoft.com/topic/june-13-2023-kb5027215-os-builds-19044-3086-and-19045-3086-079f9f02-fe49-4b25-99a6-c02a16b1f208
        if ($UBR -ge 3086) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4103588492' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4103588492 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Windows 11 21H2
    '22000' {
        # https://support.microsoft.com/topic/june-13-2023-kb5027223-os-build-22000-2057-168b3781-ffd0-4779-83da-162b880a0b24
        if ($UBR -ge 2057) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4204251788' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4204251788 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Windows 11 22H2
    '22621' {
        # https://support.microsoft.com/en-us/topic/june-13-2023-kb5027231-os-build-22621-1848-8f903600-1293-4431-9c6b-736a4049666c
        if ($UBR -ge 1848) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4237806220' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4237806220 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Server 2016
    '14393' {
        # https://support.microsoft.com/topic/june-13-2023-kb5027219-os-build-14393-5989-e99f2865-6f1a-41e4-9583-c0d00be7468d
        if ($UBR -ge 5989) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -ErrorAction Ignore
            if ($Value) {
                if ($Value.LazyRetryOnCommitFailure -ne 0) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Server 2019
    '17763' {
        # https://support.microsoft.com/topic/june-13-2023-kb5027222-os-build-17763-4499-8aa0687f-06aa-4789-ab4e-6bff4897a33e
        if ($UBR -ge 4499) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -ErrorAction Ignore
            if ($Value) {
                if ($Value.LazyRetryOnCommitFailure -ne 0) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Server 2022
    '20348' {
        if ($UBR -ge 1787) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4137142924' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4137142924 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
}

return $Compliant
