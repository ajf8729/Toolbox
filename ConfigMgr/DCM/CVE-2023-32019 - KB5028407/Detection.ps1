$Compliant = $true

$BuildNumber = (Get-CimInstance -ClassName Win32_OperatingSystem).BuildNumber
$UBR = (Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\' -Name 'UBR').UBR

switch ($BuildNumber) {
    # Windows 10 21H2/22H2
    {$_ -in '19044', '19045'} {
        if ($UBR -ge 3086) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4103588492' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4103588492 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Windows 11 21H2
    '22000' {
        if ($UBR -ge 2057) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4204251788' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4204251788 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Windows 11 22H2
    '22621' {
        if ($UBR -ge 1848) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4237806220' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4237806220 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Server 2016
    '14393' {
        if ($UBR -ge 5989) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -ErrorAction Ignore
            if ($Value) {
                if ($Value.LazyRetryOnCommitFailure -ne 0) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Server 2019
    '17763' {
        if ($UBR -ge 4499) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Configuration Manager' -Name 'LazyRetryOnCommitFailure' -ErrorAction Ignore
            if ($Value) {
                if ($Value.LazyRetryOnCommitFailure -ne 0) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
    # Server 2022
    '20348' {
        if ($UBR -ge 1787) {
            $Value = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides' -Name '4137142924' -ErrorAction Ignore
            if ($Value) {
                if ($Value.4137142924 -ne 1) {
                    $Compliant = $false
                }
            }
            else {
                $Compliant = $false
            }
        }
    }
}

return $Compliant
